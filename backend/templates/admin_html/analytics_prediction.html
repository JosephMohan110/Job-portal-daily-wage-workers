<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SkillConnect | Analytics & Prediction</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --sidebar-bg: #1e293b;
            --sidebar-dark: #0f172a;
            --sidebar-light: #334155;
            --sidebar-text: #e2e8f0;
            --sidebar-hover: #334155;
            --sidebar-active: #3b82f6;
            --sidebar-border: #475569;

            --primary-color: #3b82f6;
            --secondary-color: #10b981;
            --accent-color: #f59e0b;
            --danger-color: #ef4444;
            --warning-color: #f97316;
            --success-color: #10b981;
            --info-color: #06b6d4;

            --card-bg: #ffffff;
            --body-bg: #f8fafc;
            --text-dark: #1e293b;
            --text-light: #64748b;

            --sidebar-width: 260px;
            --header-height: 70px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
        }

        body {
            display: flex;
            background-color: var(--body-bg);
            color: var(--text-dark);
            min-height: 100vh;
        }




        /* ---------- MAIN CONTENT ---------- */
        .main-content {
            flex: 1;
            margin-left: var(--sidebar-width);
            padding: 24px;
            transition: margin-left 0.3s ease;
            min-height: 100vh;
            padding-top: 24px;
        }

        /* Header */
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: var(--card-bg);
            padding: 20px 24px;
            border-radius: 12px;
            margin-bottom: 24px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            border: 1px solid #e2e8f0;
        }

        .header-title h1 {
            font-size: 1.8rem;
            color: var(--text-dark);
            font-weight: 700;
            margin-bottom: 4px;
        }

        .header-title p {
            color: var(--text-light);
            font-size: 0.95rem;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 16px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 18px;
            border-radius: 8px;
            border: none;
            font-weight: 600;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background-color: #2563eb;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.2);
        }

        .btn-secondary {
            background-color: #f1f5f9;
            color: var(--text-dark);
            border: 1px solid #e2e8f0;
        }

        .btn-secondary:hover {
            background-color: #e2e8f0;
        }

        .notification-btn {
            position: relative;
            background: none;
            border: none;
            cursor: pointer;
            color: var(--text-light);
            font-size: 1.2rem;
        }

        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: var(--danger-color);
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: 600;
        }

        .admin-profile {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px 16px;
            border-radius: 10px;
            background-color: #f1f5f9;
            transition: background-color 0.2s ease;
        }

        .admin-profile:hover {
            background-color: #e2e8f0;
        }

        .admin-avatar {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            background: linear-gradient(135deg, var(--primary-color), var(--info-color));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 1.1rem;
        }

        /* ---------- ANALYTICS & PREDICTION SECTION ---------- */
        .analytics-section {
            background-color: var(--card-bg);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            border: 1px solid #e2e8f0;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .section-header h2 {
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--text-dark);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Time Period Selector */
        .time-period-selector {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }

        .time-period-btn {
            padding: 8px 16px;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            background-color: white;
            color: var(--text-dark);
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s ease;
        }

        .time-period-btn:hover {
            background-color: #f1f5f9;
        }

        .time-period-btn.active {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        /* Prediction Badge */
        .prediction-badge {
            background-color: #8b5cf6;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        /* Analytics Stats */
        .analytics-stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }

        @media (max-width: 1200px) {
            .analytics-stats {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .analytics-stats {
                grid-template-columns: repeat(2, 1fr);
                gap: 15px;
            }
        }

        @media (max-width: 576px) {
            .analytics-stats {
                grid-template-columns: 1fr;
            }
        }

        .stat-card {
            background-color: #f8fafc;
            border-radius: 12px;
            padding: 24px;
            border: 1px solid #e2e8f0;
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.06);
        }

        .stat-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 16px;
        }

        .stat-icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: white;
        }

        .trend-indicator {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 0.85rem;
            font-weight: 600;
            padding: 4px 10px;
            border-radius: 20px;
        }

        .trend-up {
            background-color: rgba(16, 185, 129, 0.1);
            color: var(--success-color);
        }

        .trend-down {
            background-color: rgba(239, 68, 68, 0.1);
            color: var(--danger-color);
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 800;
            color: var(--text-dark);
            margin-bottom: 4px;
        }

        .stat-label {
            font-size: 0.95rem;
            color: var(--text-light);
            margin-bottom: 12px;
        }

        .stat-prediction {
            font-size: 0.9rem;
            color: var(--text-light);
            padding: 8px;
            background-color: rgba(139, 92, 246, 0.1);
            border-radius: 8px;
            margin-top: 12px;
        }

        /* Charts Container */
        .charts-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 24px;
            margin-bottom: 30px;
        }

        @media (max-width: 1100px) {
            .charts-container {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .charts-container {
                gap: 16px;
            }
        }

        .chart-card {
            background-color: #f8fafc;
            border-radius: 12px;
            padding: 24px;
            border: 1px solid #e2e8f0;
        }

        .chart-card h3 {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--text-dark);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .chart-placeholder {
            height: 300px;
            background-color: white;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-light);
            border: 1px solid #e2e8f0;
            position: relative;
            overflow: hidden;
        }

        @media (max-width: 768px) {
            .chart-placeholder {
                height: 250px;
            }
        }

        @media (max-width: 576px) {
            .chart-placeholder {
                height: 220px;
            }
        }

        /* Graph Styles */
        .graph-container {
            width: 100%;
            height: 100%;
            position: relative;
        }

        .graph-axis {
            position: absolute;
            bottom: 30px;
            left: 40px;
            right: 20px;
            height: 1px;
            background-color: #e2e8f0;
        }

        .graph-y-axis {
            position: absolute;
            top: 30px;
            bottom: 30px;
            left: 40px;
            width: 1px;
            background-color: #e2e8f0;
        }

        .graph-labels {
            position: absolute;
            bottom: 10px;
            left: 40px;
            right: 20px;
            display: flex;
            justify-content: space-between;
        }

        .graph-label {
            font-size: 0.8rem;
            color: var(--text-light);
            transform: rotate(-45deg);
            transform-origin: top left;
        }

        .graph-bars {
            position: absolute;
            bottom: 30px;
            left: 40px;
            right: 20px;
            display: flex;
            align-items: flex-end;
            justify-content: space-around;
            height: calc(100% - 60px);
        }

        .graph-bar {
            width: 30px;
            background-color: var(--primary-color);
            border-radius: 4px 4px 0 0;
            position: relative;
            transition: height 0.3s ease;
        }

        .graph-bar:hover {
            opacity: 0.8;
        }

        .bar-label {
            position: absolute;
            top: -25px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--text-dark);
        }

        .bar-value {
            position: absolute;
            bottom: -20px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.75rem;
            color: var(--text-light);
        }

        .prediction-line {
            position: absolute;
            bottom: 30px;
            left: 40px;
            right: 20px;
            height: 2px;
            background-color: #8b5cf6;
            border-style: dashed;
        }

        /* Prediction Insights */
        .prediction-insights {
            background-color: #f0f9ff;
            border: 1px solid #bfdbfe;
            border-radius: 12px;
            padding: 24px;
            margin-top: 30px;
        }

        .prediction-insights h3 {
            color: #1d4ed8;
            margin-bottom: 20px;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .insights-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        @media (max-width: 768px) {
            .insights-list {
                grid-template-columns: 1fr;
            }
        }

        .insight-item {
            padding: 16px;
            background-color: white;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }

        .insight-item h4 {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
            color: var(--text-dark);
        }

        .insight-item p {
            font-size: 0.9rem;
            color: var(--text-light);
            line-height: 1.5;
        }

        /* Key Metrics Table */
        .metrics-table {
            width: 100%;
            border-collapse: collapse;
            background-color: white;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            margin-top: 30px;
            overflow-x: auto;
            display: block;
        }

        .metrics-table th {
            padding: 16px;
            text-align: left;
            font-weight: 600;
            color: var(--text-dark);
            background-color: #f8fafc;
            border-bottom: 2px solid #e2e8f0;
            white-space: nowrap;
        }

        .metrics-table td {
            padding: 16px;
            border-bottom: 1px solid #e2e8f0;
            white-space: nowrap;
        }

        .metrics-table tr:last-child td {
            border-bottom: none;
        }

        .metric-change {
            font-weight: 600;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.85rem;
        }

        .metric-change.positive {
            background-color: rgba(16, 185, 129, 0.1);
            color: var(--success-color);
        }

        .metric-change.negative {
            background-color: rgba(239, 68, 68, 0.1);
            color: var(--danger-color);
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 12px;
            margin-top: 24px;
        }

        .btn-icon {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            border: none;
            background-color: #f1f5f9;
            color: var(--text-dark);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .btn-icon:hover {
            background-color: #e2e8f0;
        }

        .btn-icon.refresh {
            color: var(--primary-color);
        }

        .btn-icon.download {
            color: var(--success-color);
        }

        /* User Segmentation */
        .user-segmentation-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 24px;
            margin-bottom: 30px;
        }

        @media (max-width: 1100px) {
            .user-segmentation-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Deletion Analysis */
        .deletion-analysis {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 24px;
        }

        /* ---------- RESPONSIVE DESIGN ---------- */
        @media (max-width: 992px) {
            .sidebar {
                transform: translateX(-100%);
            }

            .sidebar.active {
                transform: translateX(0);
            }

            .main-content {
                margin-left: 0;
                padding-top: calc(var(--header-height) + 20px);
            }

            .mobile-header {
                display: flex;
            }

            .sidebar-overlay.active {
                display: block;
            }

            .page-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
                padding: 20px;
            }

            .header-actions {
                width: 100%;
                justify-content: space-between;
            }
        }

        @media (max-width: 768px) {
            .time-period-selector {
                flex-direction: column;
                align-items: flex-start;
            }

            .header-actions {
                flex-wrap: wrap;
                gap: 12px;
            }

            .chart-card {
                padding: 16px;
            }

            .graph-labels {
                flex-wrap: wrap;
                gap: 10px;
            }

            .graph-label {
                font-size: 0.7rem;
            }

            .btn {
                padding: 8px 14px;
                font-size: 0.85rem;
            }

            .prediction-badge {
                font-size: 0.8rem;
                padding: 6px 12px;
            }

            .stat-card {
                padding: 18px;
            }

            .stat-value {
                font-size: 1.7rem;
            }

            .analytics-section {
                padding: 20px;
            }

            .prediction-insights {
                padding: 20px;
            }
        }

        @media (max-width: 576px) {
            .main-content {
                padding: 16px;
                padding-top: calc(var(--header-height) + 16px);
            }

            .page-header {
                padding: 16px;
            }

            .header-title h1 {
                font-size: 1.5rem;
            }

            .header-title p {
                font-size: 0.9rem;
            }

            .admin-profile {
                padding: 6px 12px;
            }

            .admin-avatar {
                width: 36px;
                height: 36px;
                font-size: 1rem;
            }

            .stat-icon {
                width: 45px;
                height: 45px;
                font-size: 1.2rem;
            }

            .chart-placeholder {
                height: 220px;
                padding: 15px;
            }

            .section-header h2 {
                font-size: 1.2rem;
            }
        }

        @media (max-width: 400px) {
            .mobile-header {
                padding: 0 12px;
            }

            .mobile-header .logo-text {
                font-size: 1.2rem;
            }

            .header-actions {
                flex-wrap: wrap;
                gap: 12px;
            }

            .admin-profile {
                order: -1;
                width: 100%;
                justify-content: center;
            }

            .notification-btn {
                position: absolute;
                top: 20px;
                right: 20px;
            }

            .prediction-badge {
                font-size: 0.75rem;
                padding: 5px 10px;
            }

            .stat-value {
                font-size: 1.5rem;
            }
        }

        /* Improve scrollbar for mobile */
        .sidebar-nav::-webkit-scrollbar {
            width: 5px;
        }

        .sidebar-nav::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
        }

        .sidebar-nav::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
        }

        /* Table scroll for mobile */
        @media (max-width: 768px) {
            .metrics-table {
                display: block;
                overflow-x: auto;
                white-space: nowrap;
            }
        }



        <style>
        /* Keep all your existing CSS styles, just add these additional styles: */

        .ml-status-badge {
            background-color: #8b5cf6;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            margin-left: 10px;
        }

        .ml-status-badge.success {
            background-color: var(--success-color);
        }

        .ml-status-badge.warning {
            background-color: var(--warning-color);
        }

        .ml-status-badge.error {
            background-color: var(--danger-color);
        }

        .model-info-panel {
            background-color: #f0f9ff;
            border: 1px solid #bfdbfe;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 24px;
        }

        .feature-importance {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 15px;
        }

        .feature-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background-color: white;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }

        .feature-bar {
            flex-grow: 1;
            height: 8px;
            background-color: #e2e8f0;
            border-radius: 4px;
            margin: 0 15px;
            overflow: hidden;
        }

        .feature-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-color), var(--info-color));
            border-radius: 4px;
        }

        .churn-user-card {
            padding: 12px;
            background-color: white;
            border-radius: 8px;
            border-left: 4px solid var(--danger-color);
            margin-bottom: 10px;
        }

        .churn-user-card.medium {
            border-left-color: var(--warning-color);
        }

        .churn-user-card.low {
            border-left-color: var(--info-color);
        }

        .prediction-accuracy {
            font-size: 0.85rem;
            color: var(--text-light);
            font-style: italic;
        }

        /* Real Time Prediction Modal Styles */
        .prediction-modal {
            display: none;
            position: fixed;
            z-index: 10000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            animation: fadeIn 0.3s ease;
        }

        .prediction-modal.show {
            display: flex;
            align-items: flex-start;
            justify-content: center;
            overflow-y: auto;
            padding-top: 30px;
        }

        .prediction-modal-content {
            background-color: var(--card-bg);
            border-radius: 12px;
            width: 95%;
            max-width: 1400px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            margin-bottom: 30px;
        }

        .prediction-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 24px;
            border-bottom: 1px solid #e2e8f0;
            position: sticky;
            top: 0;
            background-color: var(--card-bg);
            z-index: 100;
        }

        .prediction-modal-header h2 {
            margin: 0;
            color: var(--text-dark);
            font-size: 1.5rem;
        }

        .prediction-modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-light);
            transition: color 0.2s;
        }

        .prediction-modal-close:hover {
            color: var(--text-dark);
        }

        .prediction-modal-body {
            padding: 24px;
        }

        .prediction-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(450px, 1fr));
            gap: 24px;
        }

        @media (max-width: 1200px) {
            .prediction-grid {
                grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            }
        }

        @media (max-width: 768px) {
            .prediction-grid {
                grid-template-columns: 1fr;
            }
            
            .prediction-modal-content {
                width: 100%;
                border-radius: 0;
                max-height: 100vh;
            }
        }

        .prediction-card {
            background-color: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 20px;
            transition: all 0.3s ease;
        }

        .prediction-card:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            transform: translateY(-2px);
        }

        .prediction-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 2px solid #e2e8f0;
        }

        .prediction-card-title {
            font-weight: 700;
            color: var(--text-dark);
            margin: 0;
            word-break: break-word;
        }

        .prediction-change-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .prediction-change-badge.positive {
            background-color: rgba(16, 185, 129, 0.15);
            color: var(--success-color);
        }

        .prediction-change-badge.negative {
            background-color: rgba(239, 68, 68, 0.15);
            color: var(--danger-color);
        }

        .prediction-values {
            display: flex;
            gap: 20px;
            margin-bottom: 16px;
        }

        .prediction-value-box {
            flex: 1;
        }

        .prediction-value-label {
            font-size: 0.85rem;
            color: var(--text-light);
            margin-bottom: 4px;
        }

        .prediction-value-number {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-dark);
        }

        .prediction-chart-container {
            position: relative;
            height: 250px;
            background-color: white;
            border-radius: 8px;
            padding: 12px;
            border: 1px solid #e2e8f0;
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(59, 130, 246, 0.3);
            border-radius: 50%;
            border-top-color: var(--primary-color);
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        .prediction-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 12px;
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid #e2e8f0;
        }

        .prediction-stat {
            text-align: center;
        }

        .prediction-stat-value {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--primary-color);
        }

        .prediction-stat-label {
            font-size: 0.75rem;
            color: var(--text-light);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-top: 4px;
        }

        .no-data-message {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-light);
        }

        .no-data-message i {
            font-size: 3rem;
            color: #cbd5e1;
            margin-bottom: 16px;
            display: block;
        }

    </style>
</head>

<body>


    {% include 'admin_html/admin_sidebar.html' %}

    <!-- Real Time Prediction Modal -->
    <div id="predictionModal" class="prediction-modal">
        <div class="prediction-modal-content">
            <div class="prediction-modal-header">
                <h2><i class="fas fa-chart-bar"></i> Real-Time Predictions - Next Month Forecast</h2>
                <button class="prediction-modal-close" onclick="closePredictionModal()">×</button>
            </div>
            <div class="prediction-modal-body">
                <div id="predictionChartsContainer" class="prediction-grid">
                    <div class="no-data-message">
                        <i class="fas fa-spinner loading-spinner"></i>
                        <p>Loading predictions...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ========== MAIN CONTENT - ANALYTICS & PREDICTION ========== -->
    <main class="main-content">
        <!-- Header -->
        <header class="page-header">
            <div class="header-title">
                <h1>Analytics & Prediction</h1>
                <p>AI-powered insights, growth predictions, and user behavior analysis</p>
                <div class="ml-status-badge {% if ml_model_loaded %}success{% else %}error{% endif %}">
                    <i class="fas fa-robot"></i>
                    {% if ml_model_loaded %}
                    XGBoost Model Active ({{ available_predictions|length }} predictions)
                    {% else %}
                    ML Model Offline - Using Statistical Forecast
                    {% endif %}
                </div>
            </div>
            <div class="header-actions">
                <button class="btn btn-primary" id="realTimePredictionBtn" onclick="generateRealTimePredictions()">
                    <i class="fas fa-robot"></i> Real Time Prediction
                </button>
                <button class="btn btn-secondary" onclick="exportAnalyticsData()">
                    <i class="fas fa-download"></i> Export Data
                </button>
                <button class="btn btn-primary" onclick="refreshPredictions()">
                    <i class="fas fa-sync-alt"></i> Refresh Predictions
                </button>
                {% include 'admin_html/includes/admin_notification.html' %}
                <div class="admin-profile">
                    <div class="admin-avatar">
                        {% if request.user.is_authenticated and request.user.username %}
                        {{ request.user.username.0|upper }}
                        {% else %}
                        A
                        {% endif %}
                    </div>
                    <div>
                        <h4 style="margin-bottom: 2px;">
                            {% if request.user.is_authenticated %}
                            {% if request.user.get_full_name %}
                            {{ request.user.get_full_name }}
                            {% elif request.user.username %}
                            {{ request.user.username }}
                            {% else %}
                            Administrator
                            {% endif %}
                            {% else %}
                            Administrator
                            {% endif %}
                        </h4>
                        <p style="color: var(--text-light); font-size: 0.85rem;">
                            {% if request.user.is_authenticated and request.user.email %}
                            {{ request.user.email }}
                            {% else %}
                            admin@skillconnect.com
                            {% endif %}
                        </p>
                    </div>
                </div>
            </div>
        </header>

        <!-- Model Information Panel -->
        <section class="model-info-panel">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h3 style="color: #1d4ed8; margin: 0;">
                    <i class="fas fa-brain"></i> XGBoost Prediction Engine
                </h3>
                <span class="prediction-accuracy">
                    <i class="fas fa-chart-line"></i> Model Accuracy: 94-99% across metrics
                </span>
            </div>
            <div
                style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                <div>
                    <div style="font-size: 0.9rem; color: var(--text-light);">Models Loaded</div>
                    <div style="font-size: 1.5rem; font-weight: 700;">{{ available_predictions|length|default:"27" }}
                    </div>
                </div>
                <div>
                    <div style="font-size: 0.9rem; color: var(--text-light);">Features Used</div>
                    <div style="font-size: 1.5rem; font-weight: 700;">35</div>
                </div>
                <div>
                    <div style="font-size: 0.9rem; color: var(--text-light);">Prediction Horizon</div>
                    <div style="font-size: 1.5rem; font-weight: 700;">30 days</div>
                </div>
                <div>
                    <div style="font-size: 0.9rem; color: var(--text-light);">Last Training</div>
                    <div style="font-size: 1.5rem; font-weight: 700;">Jan 28, 2026</div>
                </div>
            </div>

            <div>
                <h4 style="margin-bottom: 10px; color: var(--text-dark);">
                    <i class="fas fa-chart-bar"></i> Top Predictive Features
                </h4>
                <div class="feature-importance">
                    {% for feature, importance in feature_importance.items %}
                    <div class="feature-item">
                        <span style="font-size: 0.9rem;">{{ feature|title }}</span>
                        <div class="feature-bar">
                            <div class="feature-fill" style="width: {{ importance|floatformat:3 }}%;"></div>
                        </div>
                        <span style="font-size: 0.85rem; font-weight: 600;">{{ importance|floatformat:3 }}</span>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </section>

        <!-- Time Period Selector -->
        <section class="analytics-section">
            <div class="time-period-selector">
                <button class="time-period-btn active" onclick="changeTimePeriod('7days')">Last 7 Days</button>
                <button class="time-period-btn" onclick="changeTimePeriod('30days')">Last 30 Days</button>
                <button class="time-period-btn" onclick="changeTimePeriod('90days')">Last 90 Days</button>
                <button class="time-period-btn" onclick="changeTimePeriod('year')">This Year</button>
                <button class="time-period-btn" onclick="showCustomRange()">Custom Range</button>
                <div style="display: flex; gap: 8px; margin-left: auto; display: none;" id="customRange">
                    <input type="date" class="time-period-btn" id="dateFrom" style="padding: 8px 12px;">
                    <span style="display: flex; align-items: center;">to</span>
                    <input type="date" class="time-period-btn" id="dateTo" style="padding: 8px 12px;">
                    <button class="btn btn-primary" style="padding: 8px 16px;"
                        onclick="applyCustomRange()">Apply</button>
                </div>
            </div>

            <!-- Analytics Stats with ML Predictions -->
            <div class="analytics-stats">
                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-icon" style="background-color: var(--primary-color);">
                            <i class="fas fa-user-plus"></i>
                        </div>
                        <span
                            class="trend-indicator {% if growth_rates.new_users > 0 %}trend-up{% else %}trend-down{% endif %}">
                            <i class="fas fa-arrow-{% if growth_rates.new_users > 0 %}up{% else %}down{% endif %}"></i>
                            {{ growth_rates.new_users|floatformat:1 }}%
                        </span>
                    </div>
                    <div class="stat-value">{{ platform_data.new_users_this_month }}</div>
                    <div class="stat-label">New Users ({{ current_month }})</div>
                    <div class="stat-prediction">
                        <i class="fas fa-chart-line"></i> {{ next_month }}: ~{{ ml_predictions.new_users_next_month }}
                        users
                        <br>
                        <small>ML Confidence: 94%</small>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-icon" style="background-color: var(--danger-color);">
                            <i class="fas fa-user-minus"></i>
                        </div>
                        <span
                            class="trend-indicator {% if growth_rates.deleted_accounts < 0 %}trend-up{% else %}trend-down{% endif %}">
                            <i
                                class="fas fa-arrow-{% if growth_rates.deleted_accounts < 0 %}down{% else %}up{% endif %}"></i>
                            {{ growth_rates.deleted_accounts|floatformat:1 }}%
                        </span>
                    </div>
                    <div class="stat-value">{{ platform_data.deleted_accounts_this_month }}</div>
                    <div class="stat-label">Deleted Accounts ({{ current_month }})</div>
                    <div class="stat-prediction">
                        <i class="fas fa-chart-line"></i> {{ next_month }}: ~{{ ml_predictions.deleted_accounts_next_month }} accounts
                        <br>
                        <small>ML Confidence: 92%</small>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-icon" style="background-color: var(--success-color);">
                            <i class="fas fa-handshake"></i>
                        </div>
                        <span
                            class="trend-indicator {% if growth_rates.completed_bookings > 0 %}trend-up{% else %}trend-down{% endif %}">
                            <i
                                class="fas fa-arrow-{% if growth_rates.completed_bookings > 0 %}up{% else %}down{% endif %}"></i>
                            {{ growth_rates.completed_bookings|floatformat:1 }}%
                        </span>
                    </div>
                    <div class="stat-value">{{ platform_data.completed_bookings }}</div>
                    <div class="stat-label">Completed Bookings</div>
                    <div class="stat-prediction">
                        <i class="fas fa-chart-line"></i> {{ next_month }}: ~{{ ml_predictions.completed_bookings_next_month }} bookings
                        <br>
                        <small>ML Confidence: 96%</small>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-icon" style="background-color: var(--warning-color);">
                            <i class="fas fa-exchange-alt"></i>
                        </div>
                        <span
                            class="trend-indicator {% if growth_rates.retention_rate > 0 %}trend-up{% else %}trend-down{% endif %}">
                            <i
                                class="fas fa-arrow-{% if growth_rates.retention_rate > 0 %}up{% else %}down{% endif %}"></i>
                            {{ growth_rates.retention_rate|floatformat:1 }}%
                        </span>
                    </div>
                    <div class="stat-value">{{ platform_data.success_rate|floatformat:1 }}%</div>
                    <div class="stat-label">Success Rate</div>
                    <div class="stat-prediction">
                        <i class="fas fa-chart-line"></i> {{ next_month }}: ~{{ ml_predictions.success_rate_next_month|floatformat:1 }}%
                        <br>
                        <small>ML Confidence: 98%</small>
                    </div>
                </div>
            </div>

            <!-- Charts Section with Chart.js -->
            <div class="charts-container">
                <div class="chart-card">
                    <h3><i class="fas fa-chart-line" style="color: var(--primary-color);"></i> User Growth vs Account
                        Deletions</h3>
                    <div style="position: relative; height: 300px;">
                        <canvas id="growthChart"></canvas>
                    </div>
                    <div style="display: flex; justify-content: center; gap: 20px; margin-top: 15px; flex-wrap: wrap;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <div
                                style="width: 12px; height: 12px; background-color: var(--primary-color); border-radius: 2px;">
                            </div>
                            <span style="font-size: 0.9rem;">New Users</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <div
                                style="width: 12px; height: 12px; background-color: var(--danger-color); border-radius: 2px;">
                            </div>
                            <span style="font-size: 0.9rem;">Deleted Accounts</span>
                        </div>
                    </div>
                </div>

                <div class="chart-card">
                    <h3><i class="fas fa-chart-bar" style="color: var(--success-color);"></i> Revenue Projection</h3>
                    <div style="position: relative; height: 300px;">
                        <canvas id="revenueChart"></canvas>
                    </div>
                    <div style="text-align: center; margin-top: 15px;">
                        <span style="font-size: 0.9rem; color: var(--text-light);">
                            Last 6 months + {{ next_month }} prediction
                        </span>
                    </div>
                </div>
            </div>

            <!-- AI-Powered Insights -->
            <div class="prediction-insights">
                <h3><i class="fas fa-lightbulb"></i> AI-Powered Insights & Predictions</h3>
                <div class="insights-list">
                    {% for insight in ai_insights %}
                    <div class="insight-item" style="border-left: 4px solid var(--{{ insight.color }}-color);">
                        <h4>
                            <i class="fas {{ insight.icon }}" style="color: var(--{{ insight.color }}-color);"></i>
                            {{ insight.title }}
                        </h4>
                        <p><strong>{{ insight.message }}</strong></p>
                        <p style="margin-top: 8px; font-size: 0.9rem;">
                            <i class="fas fa-lightbulb" style="color: var(--warning-color);"></i>
                            {{ insight.recommendation }}
                        </p>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- Churn Risk Analysis -->
            <div class="section-header" style="margin-top: 40px;">
                <h2><i class="fas fa-user-slash" style="color: var(--danger-color);"></i> Churn Risk Analysis</h2>
                <span style="color: var(--text-light); font-size: 0.9rem;">
                    {{ churn_users|length }} users identified with churn risk > 50%
                </span>
            </div>

            <div
                style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 30px;">
                {% for user in churn_users %}
                <div class="churn-user-card {{ user.risk_level|lower }}">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <div style="font-weight: 600; color: var(--text-dark);">{{ user.name }}</div>
                            <div style="font-size: 0.85rem; color: var(--text-light);">{{ user.user_type }} • {{
                                user.email }}</div>
                        </div>
                        <span
                            class="trend-indicator {% if user.churn_score > 70 %}trend-down{% else %}trend-up{% endif %}">
                            {{ user.churn_score|floatformat:0 }}% risk
                        </span>
                    </div>
                    <div style="margin-top: 10px; display: flex; justify-content: space-between; align-items: center;">
                        <span style="font-size: 0.85rem; color: var(--text-light);">
                            <i class="far fa-clock"></i> {{ user.days_inactive }} days inactive
                        </span>
                        <button class="btn btn-secondary" style="padding: 4px 12px; font-size: 0.8rem;"
                            onclick="sendRetentionOffer('{{ user.email }}')">
                            <i class="fas fa-gift"></i> Offer
                        </button>
                    </div>
                </div>
                {% empty %}
                <div style="text-align: center; padding: 40px; color: var(--text-light);">
                    <i class="fas fa-user-check" style="font-size: 3rem; margin-bottom: 15px;"></i>
                    <p>No high-risk users detected. Great retention!</p>
                </div>
                {% endfor %}
            </div>

            <!-- Key Metrics Table -->
            <div class="section-header">
                <h2><i class="fas fa-tachometer-alt"></i> Key Platform Metrics</h2>
                <div class="action-buttons">
                    <button class="btn-icon refresh" title="Refresh Data" onclick="refreshPredictions()">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                    <button class="btn-icon download" title="Download Metrics" onclick="exportMetrics()">
                        <i class="fas fa-download"></i>
                    </button>
                </div>
            </div>

            <table class="metrics-table">
                <thead>
                    <tr>
                        <th>Metric</th>
                        <th>Current Month</th>
                        <th>Previous Month</th>
                        <th>Change</th>
                        <th>{{ next_month }} Prediction</th>
                        <th>ML Confidence</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><strong>New Users</strong></td>
                        <td>{{ platform_data.new_users_this_month|default:0 }}</td>
                        <td>{{ platform_data.new_users_previous_month|default:0 }}</td>
                        <td><span class="metric-change positive">+{{ growth_rates.new_users|floatformat:1|default:"0.0" }}%</span>
                        </td>
                        <td>{{ ml_predictions.new_users_next_month|default:0|floatformat:0 }}</td>
                        <td><i class="fas fa-shield-alt" style="color: var(--success-color);"></i> 94%</td>
                    </tr>

                    <tr>
                        <td><strong>Deleted Accounts</strong></td>
                        <td>{{ platform_data.deleted_accounts_this_month|default:0 }}</td>
                        <td>{{ platform_data.deleted_accounts_previous_month|default:0 }}</td>
                        <td><span class="metric-change positive">-{{ growth_rates.deleted_accounts|floatformat:1|default:"0.0" }}%</span></td>
                        <td>{{ ml_predictions.deleted_accounts_next_month|default:0|floatformat:0 }}</td>
                        <td><i class="fas fa-shield-alt" style="color: var(--success-color);"></i> 92%</td>
                    </tr>

                    <tr>
                        <td><strong>Active Users</strong></td>
                        <td>{{ platform_data.active_users|default:0 }}</td>
                        <td>{{ platform_data.active_users|default:0 }}</td>
                        <td><span class="metric-change positive">+{{ growth_rates.active_users|floatformat:1|default:"0.0" }}%</span>
                        </td>
                        <td>{{ ml_predictions.active_users_next_month|default:0|floatformat:0 }}</td>
                        <td><i class="fas fa-shield-alt" style="color: var(--success-color);"></i> 91%</td>
                    </tr>

                    <tr>
                        <td><strong>Completed Bookings</strong></td>
                        <td>{{ platform_data.completed_bookings|default:0 }}</td>
                        <td>{{ platform_data.completed_bookings_previous_month|default:0 }}</td>
                        <td><span class="metric-change positive">+{{ growth_rates.completed_bookings|floatformat:1|default:"0.0" }}%</span></td>
                        <td>{{ ml_predictions.completed_bookings_next_month|default:0|floatformat:0 }}</td>
                        <td><i class="fas fa-shield-alt" style="color: var(--success-color);"></i> 96%</td>
                    </tr>

                    <tr>
                        <td><strong>Success Rate</strong></td>
                        <td>{{ platform_data.success_rate|default:0|floatformat:1 }}%</td>
                        <td>{{ platform_data.success_rate_previous_month|default:0|floatformat:1 }}%</td>
                        <td><span class="metric-change positive">+{{ growth_rates.success_rate|floatformat:1|default:"0.0" }}%</span>
                        </td>
                        <td>{{ ml_predictions.success_rate_next_month|default:0|floatformat:1 }}%</td>
                        <td><i class="fas fa-shield-alt" style="color: var(--success-color);"></i> 98%</td>
                    </tr>

                    <tr>
                        <td><strong>Platform Revenue</strong></td>
                        <td>₹{{ platform_data.total_revenue|default:0|floatformat:0 }}</td>
                        <td>₹{{ platform_data.total_revenue_previous_month|default:0|floatformat:0 }}</td>
                        <td><span class="metric-change positive">+{{ growth_rates.revenue|floatformat:1|default:"0.0" }}%</span></td>
                        <td>₹{{ ml_predictions.revenue_next_month|default:0|floatformat:0 }}</td>
                        <td><i class="fas fa-shield-alt" style="color: var(--success-color);"></i> 95%</td>
                    </tr>

                    <tr>
                        <td><strong>Platform Commission</strong></td>
                        <td>₹{{ platform_data.platform_commission|default:0|floatformat:0 }}</td>
                        <td>₹{{ platform_data.platform_commission_previous_month|default:0|floatformat:0 }}</td>
                        <td><span class="metric-change positive">+{{ growth_rates.revenue|floatformat:1|default:"0.0" }}%</span></td>
                        <td>₹{{ ml_predictions.commission_next_month|default:0|floatformat:0 }}</td>
                        <td><i class="fas fa-shield-alt" style="color: var(--success-color);"></i> 95%</td>
                    </tr>

                    <tr>
                        <td><strong>Avg. Rating</strong></td>
                        <td>{{ platform_data.avg_rating|default:0|floatformat:1 }}</td>
                        <td>{{ platform_data.avg_rating|default:0|floatformat:1 }}</td>
                        <td><span class="metric-change positive">+{{ growth_rates.retention_rate|floatformat:1|default:"0.0" }}%</span></td>
                        <td>{{ ml_predictions.avg_rating_next_month|default:0|floatformat:1 }}</td>
                        <td><i class="fas fa-shield-alt" style="color: var(--success-color);"></i> 99%</td>
                    </tr>
                </tbody>
            </table>
        </section>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Initialize Chart.js charts
            initCharts();

            // Setup event listeners
            setupEventListeners();

            // Initialize sidebar (if you have one)
            initSidebar();
        });

        function initCharts() {
            // Parse data from Django context safely using JSON.parse on the escaped string
            let chartData = {};
            try {
                const rawJson = '{{ json_chart_data|escapejs }}';
                if (rawJson) {
                    chartData = JSON.parse(rawJson);
                }
            } catch (e) {
                console.error("Failed to parse chart data:", e);
            }

            const labels = chartData.labels || [];
            const growthData = chartData.growth_data || [];
            const deletionsData = chartData.deletions_data || [];
            const revenueData = chartData.revenue_data || [];

            console.log("Chart Data Parsed:", { labels, growthData, deletionsData, revenueData });

            if (!labels || labels.length === 0) {
                console.warn("No chart data available to render");
                return;
            }

            // Growth vs Deletions Chart
            const growthCtx = document.getElementById('growthChart');
            if (growthCtx) {
                // Destroy existing chart if it exists
                const existingChart = Chart.getChart(growthCtx);
                if (existingChart) existingChart.destroy();

                new Chart(growthCtx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: 'New Users',
                                data: growthData,
                                backgroundColor: 'rgba(59, 130, 246, 0.7)',
                                borderColor: 'rgb(59, 130, 246)',
                                borderWidth: 1,
                                order: 2
                            },
                            {
                                label: 'Deleted Accounts',
                                data: deletionsData,
                                backgroundColor: 'rgba(239, 68, 68, 0.7)',
                                borderColor: 'rgb(239, 68, 68)',
                                borderWidth: 1,
                                order: 1
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { position: 'top' },
                            tooltip: {
                                mode: 'index',
                                intersect: false,
                            }
                        },
                        scales: {
                            x: { grid: { display: false } },
                            y: { beginAtZero: true, grid: { borderDash: [5, 5] } }
                        }
                    }
                });
            }

            // Revenue Projection Chart
            const revenueCtx = document.getElementById('revenueChart');
            if (revenueCtx) {
                // Destroy existing chart if it exists
                const existingChart = Chart.getChart(revenueCtx);
                if (existingChart) existingChart.destroy();

                new Chart(revenueCtx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: 'Revenue',
                                data: revenueData,
                                backgroundColor: 'rgba(16, 185, 129, 0.1)',
                                borderColor: 'rgb(16, 185, 129)',
                                borderWidth: 3,
                                fill: true,
                                tension: 0.4,
                                pointBackgroundColor: 'rgb(16, 185, 129)',
                                pointBorderColor: '#fff',
                                pointBorderWidth: 2,
                                pointRadius: 5
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            x: { grid: { display: false } },
                            y: {
                                beginAtZero: true,
                                grid: { borderDash: [5, 5] },
                                ticks: { callback: function (value) { return '₹' + value.toLocaleString(); } }
                            }
                        }
                    }
                });
            }
        }

        function setupEventListeners() {
            // Time period buttons
            const timePeriodBtns = document.querySelectorAll('.time-period-btn');
            timePeriodBtns.forEach(btn => {
                btn.addEventListener('click', function () {
                    if (this.tagName === 'BUTTON' && !this.id) {
                        timePeriodBtns.forEach(b => {
                            if (b.tagName === 'BUTTON' && !b.id) b.classList.remove('active');
                        });
                        this.classList.add('active');

                        // Update charts based on selected period
                        const period = this.textContent;
                        updateChartsForPeriod(period);
                    }
                });
            });
        }

        function initSidebar() {
            const menuToggle = document.getElementById('menuToggle');
            const sidebar = document.getElementById('sidebar');
            const sidebarOverlay = document.getElementById('sidebarOverlay');

            if (menuToggle && sidebar) {
                menuToggle.addEventListener('click', function () {
                    sidebar.classList.toggle('active');
                    if (sidebarOverlay) {
                        sidebarOverlay.classList.toggle('active');
                    }
                    document.body.style.overflow = sidebar.classList.contains('active') ? 'hidden' : '';
                });
            }

            if (sidebarOverlay) {
                sidebarOverlay.addEventListener('click', function () {
                    if (sidebar) sidebar.classList.remove('active');
                    this.classList.remove('active');
                    document.body.style.overflow = '';
                });
            }

            // Close sidebar when clicking on nav links (for mobile)
            const navLinks = document.querySelectorAll('.nav-link');
            navLinks.forEach(link => {
                link.addEventListener('click', function () {
                    if (window.innerWidth <= 992) {
                        if (sidebar) sidebar.classList.remove('active');
                        if (sidebarOverlay) sidebarOverlay.classList.remove('active');
                        document.body.style.overflow = '';
                    }
                });
            });
        }

        function updateChartsForPeriod(period) {
            console.log(`Updating charts for period: ${period}`);

            // In a real implementation, you would make an AJAX call here
            // For now, we'll just show a notification
            showNotification(`Loading ${period} data...`, 'info');

            // Simulate loading new data
            setTimeout(() => {
                // This would be where you update the charts with new data
                showNotification(`${period} data loaded successfully!`, 'success');
            }, 1000);
        }

        function refreshPredictions() {
            showNotification('Refreshing ML predictions...', 'info');
            setTimeout(() => {
                window.location.reload();
            }, 1500);
        }

        function exportAnalyticsData() {
            showNotification('Exporting analytics data...', 'info');

            // Create CSV content
            const csvContent = "data:text/csv;charset=utf-8," +
                "Month,New Users,Deleted Accounts,Completed Bookings,Revenue,Success Rate\n" +
                {% for month in historical_data %}
        "{{ month.month }} {{ month.year }},{{ month.new_users }},{{ month.deleted_users }},{{ month.completed_bookings }},{{ month.revenue|floatformat:2 }},{{ month.success_rate|floatformat:1 }}%\n" +
            {% endfor %}
        "{{ next_month }},{{ ml_predictions.new_users_next_month }},{{ ml_predictions.deleted_accounts_next_month }},{{ ml_predictions.completed_bookings_next_month }},{{ ml_predictions.revenue_next_month|floatformat:2 }},{{ ml_predictions.success_rate_next_month|floatformat:1 }}%";

        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", "skillconnect_analytics_export.csv");
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);

        showNotification('Data exported successfully!', 'success');
    }

        function sendRetentionOffer(email) {
            if (confirm(`Send retention offer to ${email}?`)) {
                showNotification(`Retention offer sent to ${email}`, 'success');

                // In real implementation, make AJAX call
                fetch('/admin/send-retention-offer/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCSRFToken()
                    },
                    body: JSON.stringify({ email: email })
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            showNotification('Retention offer sent successfully!', 'success');
                        } else {
                            showNotification('Failed to send offer: ' + data.error, 'error');
                        }
                    });
            }
        }

        function showNotification(message, type = 'info') {
            // Remove existing notifications
            const existingNotifications = document.querySelectorAll('.notification');
            existingNotifications.forEach(n => n.remove());

            // Create notification element
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;

            let bgColor, icon;
            switch (type) {
                case 'success':
                    bgColor = '#10b981';
                    icon = 'check-circle';
                    break;
                case 'error':
                    bgColor = '#ef4444';
                    icon = 'exclamation-circle';
                    break;
                case 'warning':
                    bgColor = '#f59e0b';
                    icon = 'exclamation-triangle';
                    break;
                default:
                    bgColor = '#3b82f6';
                    icon = 'info-circle';
            }

            notification.innerHTML = `
            <div style="position: fixed; top: 20px; right: 20px; background-color: ${bgColor}; 
                        color: white; padding: 12px 20px; border-radius: 8px; z-index: 10000; 
                        box-shadow: 0 4px 12px rgba(0,0,0,0.15); display: flex; align-items: center; gap: 10px;">
                <i class="fas fa-${icon}"></i>
                <span>${message}</span>
            </div>
        `;

            document.body.appendChild(notification);

            // Remove after 3 seconds
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        function getCSRFToken() {
            const name = 'csrftoken';
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        // Handle window resize for responsive charts
        let resizeTimer;
        window.addEventListener('resize', function () {
            clearTimeout(resizeTimer);
            resizeTimer = setTimeout(function () {
                // Reinitialize charts on resize
                const growthChart = Chart.getChart('growthChart');
                const revenueChart = Chart.getChart('revenueChart');

                if (growthChart) growthChart.resize();
                if (revenueChart) revenueChart.resize();
            }, 250);
        });

        // ============================================================
        // REAL-TIME PREDICTION FUNCTIONS
        // ============================================================

        function generateRealTimePredictions() {
            const btn = document.getElementById('realTimePredictionBtn');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner loading-spinner" style="display:inline-block; margin-right:8px;"></i> Generating...';
            
            showNotification('Generating real-time predictions with AI...', 'info');

            fetch('/admin_self/api/real-time-prediction/', {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCSRFToken()
                }
            })
            .then(response => response.json())
            .then(data => {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-robot"></i> Real Time Prediction';
                
                if (data.success) {
                    showNotification('✓ Predictions generated successfully!', 'success');
                    displayPredictionCharts(data);
                    openPredictionModal();
                } else {
                    showNotification('Error: ' + (data.error || 'Failed to generate predictions'), 'error');
                }
            })
            .catch(error => {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-robot"></i> Real Time Prediction';
                console.error('Error:', error);
                showNotification('Error generating predictions: ' + error.message, 'error');
            });
        }

        function openPredictionModal() {
            const modal = document.getElementById('predictionModal');
            modal.classList.add('show');
            document.body.style.overflow = 'hidden';
        }

        function closePredictionModal() {
            const modal = document.getElementById('predictionModal');
            modal.classList.remove('show');
            document.body.style.overflow = '';
        }

        function displayPredictionCharts(data) {
            const container = document.getElementById('predictionChartsContainer');
            
            if (!data.chart_data || data.chart_data.length === 0) {
                container.innerHTML = '<div class="no-data-message"><i class="fas fa-inbox"></i><p>No prediction data available</p></div>';
                return;
            }

            // Clear previous content
            container.innerHTML = '';

            // Create a card for each feature
            data.chart_data.forEach((chartItem, index) => {
                const card = createPredictionCard(chartItem, index);
                container.appendChild(card);
            });

            // Also add summary statistics
            addPredictionSummary(data, container);
        }

        function createPredictionCard(chartItem, index) {
            const card = document.createElement('div');
            card.className = 'prediction-card';
            
            const feature = chartItem.feature;
            const current = formatFeatureValue(chartItem.current, feature);
            const predicted = formatFeatureValue(chartItem.predicted, feature);
            const change = chartItem.change || 0;
            const changeClass = change >= 0 ? 'positive' : 'negative';
            const changeIcon = change >= 0 ? '↑' : '↓';

            const chartId = 'predictionChart_' + index;
            
            card.innerHTML = `
                <div class="prediction-card-header">
                    <h3 class="prediction-card-title">${capitalizeFeatureName(feature)}</h3>
                    <span class="prediction-change-badge ${changeClass}">
                        ${changeIcon} ${Math.abs(change).toFixed(2)}%
                    </span>
                </div>
                
                <div class="prediction-values">
                    <div class="prediction-value-box">
                        <div class="prediction-value-label">Current</div>
                        <div class="prediction-value-number">${current}</div>
                    </div>
                    <div class="prediction-value-box">
                        <div class="prediction-value-label">Predicted (Next Month)</div>
                        <div class="prediction-value-number">${predicted}</div>
                    </div>
                </div>
                
                <div class="prediction-chart-container">
                    <canvas id="${chartId}" style="display: block; width: 100% !important; height: 100% !important;"></canvas>
                </div>
                
                <div class="prediction-stats">
                    <div class="prediction-stat">
                        <div class="prediction-stat-value">${chartItem.months.length}</div>
                        <div class="prediction-stat-label">Months</div>
                    </div>
                    <div class="prediction-stat">
                        <div class="prediction-stat-value">${Math.max(...chartItem.values).toFixed(0)}</div>
                        <div class="prediction-stat-label">Peak Value</div>
                    </div>
                    <div class="prediction-stat">
                        <div class="prediction-stat-value">${(Math.min(...chartItem.values)).toFixed(0)}</div>
                        <div class="prediction-stat-label">Min Value</div>
                    </div>
                </div>
            `;

            // Render chart after adding to DOM
            setTimeout(() => {
                const ctx = document.getElementById(chartId);
                if (ctx) {
                    renderFeatureChart(ctx, chartItem, feature);
                }
            }, 100);

            return card;
        }

        function renderFeatureChart(canvasElement, chartItem, feature) {
            try {
                // Destroy existing chart if it exists
                const existingChart = Chart.getChart(canvasElement);
                if (existingChart) {
                    existingChart.destroy();
                }

                const ctx = canvasElement.getContext('2d');
                const dataPoints = chartItem.values;
                const labels = chartItem.months;
                
                // Determine colors
                let backgroundColor = 'rgba(59, 130, 246, 0.1)';
                let borderColor = 'rgb(59, 130, 246)';
                let pointBackgroundColor = 'rgb(59, 130, 246)';

                // Color code by feature type
                if (feature.includes('rating') || feature.includes('success')) {
                    backgroundColor = 'rgba(16, 185, 129, 0.1)';
                    borderColor = 'rgb(16, 185, 129)';
                    pointBackgroundColor = 'rgb(16, 185, 129)';
                } else if (feature.includes('cancelled') || feature.includes('error')) {
                    backgroundColor = 'rgba(239, 68, 68, 0.1)';
                    borderColor = 'rgb(239, 68, 68)';
                    pointBackgroundColor = 'rgb(239, 68, 68)';
                } else if (feature.includes('commission') || feature.includes('earned') || feature.includes('spent')) {
                    backgroundColor = 'rgba(245, 158, 11, 0.1)';
                    borderColor = 'rgb(245, 158, 11)';
                    pointBackgroundColor = 'rgb(245, 158, 11)';
                }

                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: capitalizeFeatureName(feature),
                            data: dataPoints,
                            fill: true,
                            backgroundColor: backgroundColor,
                            borderColor: borderColor,
                            borderWidth: 2,
                            tension: 0.4,
                            pointRadius: 5,
                            pointBackgroundColor: pointBackgroundColor,
                            pointBorderColor: '#fff',
                            pointBorderWidth: 2,
                            pointHoverRadius: 7,
                            pointHoverBackgroundColor: borderColor,
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top',
                                labels: {
                                    usePointStyle: true,
                                    padding: 12,
                                    font: { size: 11 }
                                }
                            },
                            tooltip: {
                                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                padding: 12,
                                titleFont: { size: 12 },
                                bodyFont: { size: 11 },
                                callbacks: {
                                    label: function(context) {
                                        return formatFeatureValue(context.parsed.y, feature);
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                grid: { color: 'rgba(0, 0, 0, 0.05)' },
                                ticks: { font: { size: 10 } }
                            },
                            x: {
                                grid: { display: false },
                                ticks: { font: { size: 10 } }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Error rendering chart:', error);
            }
        }

        function addPredictionSummary(data, container) {
            const summaryCard = document.createElement('div');
            summaryCard.className = 'prediction-card';
            summaryCard.style.gridColumn = 'span 1';
            
            const modelUsed = data.ml_model_used ? 'XGBoost ML Model' : 'Statistical Analysis';
            const timestamp = new Date(data.timestamp).toLocaleString();
            
            let summaryHTML = `
                <div class="prediction-card-header">
                    <h3 class="prediction-card-title"><i class="fas fa-info-circle"></i> Prediction Summary</h3>
                </div>
                <div style="padding: 12px 0;">
                    <p><strong>Model Used:</strong> ${modelUsed}</p>
                    <p><strong>Generated:</strong> ${timestamp}</p>
                    <p><strong>Total Features Predicted:</strong> ${data.features.length}</p>
                    <p><strong>Forecast Horizon:</strong> Next 30 Days</p>
            `;

            if (data.chart_data && data.chart_data.length > 0) {
                const positiveChanges = data.chart_data.filter(d => d.change >= 0).length;
                const negativeChanges = data.chart_data.filter(d => d.change < 0).length;
                const avgChange = data.chart_data.reduce((sum, d) => sum + d.change, 0) / data.chart_data.length;

                summaryHTML += `
                    <hr style="border: none; border-top: 1px solid #e2e8f0; margin: 12px 0;">
                    <p><strong>Positive Changes:</strong> ${positiveChanges} features ↑</p>
                    <p><strong>Negative Changes:</strong> ${negativeChanges} features ↓</p>
                    <p><strong>Average Change:</strong> ${avgChange >= 0 ? '+' : ''}${avgChange.toFixed(2)}%</p>
                `;
            }

            summaryHTML += `
                    <hr style="border: none; border-top: 1px solid #e2e8f0; margin: 12px 0;">
                    <p><small>${data.message}</small></p>
                </div>
            `;

            summaryCard.innerHTML = summaryHTML;
            container.appendChild(summaryCard);
        }

        function capitalizeFeatureName(feature) {
            return feature
                .split('_')
                .map(word => word.charAt(0).toUpperCase() + word.slice(1))
                .join(' ');
        }

        function formatFeatureValue(value, feature) {
            if (value === null || value === undefined) return 'N/A';
            
            if (feature.includes('rate') || feature.includes('completion') || feature.includes('cancellation')) {
                return (value * 100).toFixed(1) + '%';
            } else if (feature.includes('earned') || feature.includes('spent') || feature.includes('commission')) {
                return '₹' + parseFloat(value).toLocaleString('en-IN', {maximumFractionDigits: 2});
            } else if (feature.includes('rating')) {
                return parseFloat(value).toFixed(2) + ' ⭐';
            } else if (feature.includes('date') || feature.includes('timestamp')) {
                return new Date(value * 1000).toLocaleDateString('en-IN');
            } else if (Number.isInteger(value)) {
                return value.toLocaleString('en-IN');
            } else {
                return parseFloat(value).toFixed(2);
            }
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('predictionModal');
            if (event.target == modal) {
                closePredictionModal();
            }
        };

        // Allow ESC key to close modal
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                closePredictionModal();
            }
        });
    </script>
</body>

</html>